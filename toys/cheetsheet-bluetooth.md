---
layout: post
title: Bluetooth Cheatsheet
---

# Bluetooth & BlueZ

## Projects  

- BlueZ Source Tree: https://git.kernel.org/pub/scm/bluetooth/bluez.git
- BlueZ Official Releases: http://www.bluez.org
- Armis - BlueBorne PoC Code: https://github.com/traviswpeters/blueborne
- BluePy (Python interface to Bluetooth LE on Linux): https://github.com/IanHarvey/bluepy
- Zephyr Bluetooth tools: https://docs.zephyrproject.org/latest/guides/bluetooth/bluetooth-tools.html

## UUIDs

A universally unique identifier (UUID) is a 128-bit (16 bytes) number that is guaranteed (or has a high probability) to be globally unique.

To reconstruct the full 128-bit UUID from the shortened version, insert the 16-or 32-bit short value (indicated by xxxxxxxx , including leading zeros) into the **Bluetooth Base UUID**:
```
xxxxxxxx-0000-1000-8000-00805F9B34FB
```



## Install

Example instructions:
https://learn.adafruit.com/install-bluez-on-the-raspberry-pi/installation

*NOTE: You may need to update software versions.*

Install dependencies:
```bash
# Something not installed that you need? Try:
#   `apt-cache search KEYWORD`

sudo apt-get update
sudo apt-get -y install build-essential libusb-dev libdbus-1-dev libglib2.0-dev libudev-dev libical-dev libreadline-dev valgrind \
    libtool libelf-dev libdw-dev libjson-c-dev alsa-utils libasound2-dev libsbc-dev libsdl-dev libspeexdsp-dev libell-dev #  extras that I needed.......WTF bluez docs?!
sudo apt-get -y install python-dev python-pip python-dbus
sudo pip install pexpect
```

Get the `bluez` source code:
```bash
cd ~

#Get a specific version:
wget http://www.kernel.org/pub/linux/bluetooth/bluez-5.33.tar.gz
tar xvfz bluez-5.33.tar.gz # vs. tar xf bluez-5.33.tar.xz
cd bluez-5.33

#Get the official repo:
git clone git://git.kernel.org/pub/scm/bluetooth/bluez.git
cd bluez
```

`make` bluez w/ options for better hacking/dev:
```bash
# configure & build
/bootstrap-configure --disable-mesh --disable-btpclient && make
# Generally, you can run
#   ./bootstrap-configure
#    make
# The explicitly-disabled options were causing issues (re: embedded linux); I don't need them, so remove them!
#    --enable-mesh \
#   --enable-btpclient \
# NOTE: automatically enables all the features of interest
# NOTE: runs `./configure --enable-maintainer-mode` which removes need to use `make install` when testing `bluetoothd`

#(optional; run self-tests)
make check
```

Extra steps (not necessary; at this point you should have all the bluez software built)
```bash
#(optional; check installation)
make install DESTDIR=$PWD/x
find x
rm -rf x
#(optional; check distribution)
make distcheck
# install
sudo make install
# remove autogenerated files
make maintainer-clean
```

Some hacking options:
```bash
# Copy configuration file which specifies the required security policies
sudo cp ./src/bluetooth.conf /etc/dbus-1/system.d/

# Run daemon in foreground with debugging
sudo ./src/bluetoothd -n -d -f ./src/main.conf
```

```bash
systemctl status bluetooth      # check status
sudo systemctl start bluetooth  # start
sudo systemctl stop bluetooth   # stop

sudo systemctl enable bluetooth # enable bluez to run @ boot
sudo systemctl disable bluetooth
```

## Dev/Test

When building and testing directly from the repository it is important to
have at least automake version 1.10 or later installed.

**bluez `bootstrap` script**  
The basic scripts that uses the
autotools scripts to create the needed files for building and installing.
It makes sure to call the right programs depending on the usage of shared or
static libraries or translations etc.

**bluez `bootstrap-configure` script**  
This program will make sure to properly clean the repository, call the "bootstrap" script
*and then call configure with proper settings for development.*
It will use the best options and pass them over to configure.
These options normally include the enabling the *maintainer mode* and the *debugging features*.

**bluez `configure` script**  
So while in a normal source project the call `./configure ...` is used to
configure the project with its settings like prefix and extra options. In
case of bare repositories call "./bootstrap-configure" and it will bootstrap
the repository and calls configure with all the correct options to make
development easier.

In case of preparing for a release with `make distcheck`, don't use
`bootstrap-configure` since it could export development specific settings.

## Dev/Test Workflow

The normal steps to checkout, build and install such a repository is like this:

```bash
# Install necessary dev packages
sudo apt-get update
sudo apt-get install -y libusb-dev libdbus-1-dev libglib2.0-dev libudev-dev libical-dev libreadline-dev

# Checkout repository
git clone git://git.kernel.org/pub/scm/bluetooth/bluez.git
#vs. http://www.kernel.org/pub/linux/bluetooth/bluez-5.43.tar.xz
cd bluez

# Configure and build
./bootstrap-configure
make

# Run unit tests
make check

# Check installation
make install DESTDIR=$PWD/x
find x
rm -rf x

# Check distribution
make distcheck

# Final installation
sudo make install

# Remove autogenerated files
make maintainer-clean
```
Running from within the source code repository
```bash
# When using "./configure --enable-maintainer-mode" the automake scripts will
# use the plugins directly from within the repository. This removes the need
# to use "make install" when testing "bluetoothd". The "bootstrap-configure"
# automatically includes this option.

# Copy configuration file which specifies the required security policies
sudo cp ./src/bluetooth.conf /etc/dbus-1/system.d/

# Run daemon in foreground with debugging
sudo ./src/bluetoothd -n -d -f ./src/main.conf

# Run daemon with valgrind
#sudo valgrind --trace-children=yes --track-origins=yes --track-fds=yes \
#--show-possibly-lost=no --leak-check=full --suppressions=./tools/valgrind.supp \
#./src/bluetoothd -n -d -f ./src/main.conf
```
For production installations or distribution packaging it is important that
the "--enable-maintainer-mode" option is NOT used.

Note multiple arguments to `-d` can be specified, colon, comma or space
separated. The arguments are relative source code filenames for which
debugging output should be enabled; output shell-style globs are
accepted (e.g.: `plugins/*:src/main.c`).

## Getting Started: Bluetooth Tools & Commands

```bash
# start the bluetooth service + see which BT devices are available
systemctl start bluetooth.service && hcitool dev
# see which Bluetooth devices (controllers) are available to use
hcitool dev

# perform a scan for BLE devices on controller 'hci0'
hcitool -i hci0 lescan

# create an interactive connection with a specific Bluetooth device
gatttool -i hci1 --primary -b MAC
# Ex. gatttool -i hci1 -b 00:22:D0:33:1E:0F -I

# HCI Command — READ Link Keys (used to generate tmp keys for OTA sessions)
#           <ogf>  <ocf> <args>
hcitool cmd 0x03 0x000D 0x01

# Linux — BT Device Info (+ Link Keys?) — <BDADDR> is the address of your connected BT controller; within the directory are all of its known devices.
/var/lib/bluetooth/<BDADDR>/

# Android — btsnoop_hci.log stored at /storage/emulated/legacy/btsnoop_hci.log — fetch it by running:
adb pull /storage/emulated/legacy/btsnoop_hci.log .
# => See also: https://developer.android.com/studio/command-line/adb
```

```bash
# bluepy
python btle.py xx:xx:xx:xx:xx:xx random
```

```bash
# In case of problems connecting to the device, stop and restart the bluetooth service
sudo systemctl stop bluetooth
sudo systemctl start bluetooth
```

```bash
bluetoothctl
    power off
    power on
    agent on
    default-agent # used to ask for the pairing pin code
    scan on
    scan off
    info ADDR
    pair ADDR
    devices
    list-attributes ADDR
    select-attribute ATTR_PATH
        read
        attribute-info
        write 0x3 0x4 0x10 0x20 0x30 0x40
```

```bash
btmgmt le on
btmgmt bredr off
```

```bash
hciconfig hci0 down
hciconfig hci0 up
```

```bash
hcitool dev # show adapter
hcitool lescan # scan for BLE devices
hcitool leinfo ADDR
hcitool lecc ADDR
```

```bash
sudo gatttool -b <BLE ADDRESS> -t random -I # connect to a specific device
#   ex. ->  gatttool -b AA:BF:34:C0:95:FF -t private -I
# ONCE CONNECTED
    primary #Get the primary UUIDs
    char-desc #Get all the available handles
    char-read-hnd <handle> #Read from a handle
    char-write-req <handle> <data> #Write to a handle
```
